<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

    <div class="flex justify-between mb-4">
        <h1 class="text-2xl font-bold">Admin Panel - Orders</h1>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <!-- Orders Container -->
    <div id="ordersContainer" class="grid grid-cols-1 gap-6"></div>

    <!-- Image Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center">
        <div class="relative">
            <img id="modalImg" class="max-w-full max-h-screen rounded-lg">
            <button onclick="closeModal()" class="absolute top-2 right-2 bg-white px-3 py-1 rounded-full">✖</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

// ✅ Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBaDy2PoG_-KZVYoraD3tpU_C8CUvKQYQk",
  authDomain: "print420-bbf5b.firebaseapp.com",
  projectId: "print420-bbf5b",
  storageBucket: "print420-bbf5b.firebasestorage.app",
  messagingSenderId: "240976479161",
  appId: "1:240976479161:web:930be6bdf355e041df2c68",
  measurementId: "G-M0LMNP8EYK"
};


        // ✅ Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // ✅ Admin UIDs
        window.ADMIN_UIDS = ["FOfcAgT7VBgMr3Zf785LSpwKWAz2"];

        onAuthStateChanged(auth, (user) => {
            if (user && window.ADMIN_UIDS.includes(user.uid)) {
                fetchOrders();
            } else {
                window.location.href = "login.html";
            }
        });

        // ✅ Fetch Orders from Firestore
        async function fetchOrders() {
            const querySnapshot = await getDocs(collection(db, "orders"));
            let ordersHTML = "";

            querySnapshot.forEach((doc) => {
                const order = doc.data();
                const orderId = doc.id;

                ordersHTML += `
                    <div class="border p-6 rounded-lg shadow-md bg-white">
                        <h2 class="text-lg font-semibold">${order.name} - ₹${order.price}</h2>
                        <p><strong>Customer:</strong> ${order.fullName}</p>
                        <p><strong>Mobile:</strong> ${order.mobile}</p>
                        <p><strong>Email:</strong> ${order.email}</p>
                        <p><strong>Address:</strong> ${order.address}, ${order.city}, ${order.state}, ${order.pincode}</p>
                        <p><strong>Payment Status:</strong> ${order.paymentStatus}</p>
                        <p><strong>Order Type:</strong> ${order.type}</p>
                        <p><strong>Current Status:</strong> <span id="status-${orderId}">${order.status}</span></p>
                        
                        <div class="flex gap-4 mt-3">
                            <div class="relative">
                                <img src="${order.image1}" onclick="openModal('${order.image1}')" class="w-40 h-40 object-cover border cursor-pointer">
                                <button onclick="downloadImage('${order.image1}')" class="absolute bottom-2 left-2 bg-gray-800 text-white text-xs px-2 py-1 rounded">Download</button>
                            </div>
                            <div class="relative">
                                <img src="${order.image2}" onclick="openModal('${order.image2}')" class="w-40 h-40 object-cover border cursor-pointer">
                                <button onclick="downloadImage('${order.image2}')" class="absolute bottom-2 left-2 bg-gray-800 text-white text-xs px-2 py-1 rounded">Download</button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button onclick="updateStatus('${orderId}', '${order.status}')" class="bg-blue-500 text-white px-3 py-1 rounded">Update Status</button>
                            <button onclick="generateReceipt('${orderId}', ${JSON.stringify(order).replace(/"/g, '&quot;')})" class="bg-green-500 text-white px-3 py-1 rounded ml-2">Generate Receipt</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById("ordersContainer").innerHTML = ordersHTML;
        }

window.downloadImage = function(imageUrl) {
if (!imageUrl) {
alert("Image not found!");
return;
}

fetch(imageUrl)
.then(response => response.blob())
.then(blob => {
const objectURL = URL.createObjectURL(blob); // ✅ Create Object URL
const link = document.createElement('a');
link.href = objectURL;
link.download = "downloaded_image.jpg";
document.body.appendChild(link);
link.click();
document.body.removeChild(link);

// ✅ Delay revoke to allow multiple downloads
setTimeout(() => {
URL.revokeObjectURL(objectURL);
}, 5000); // 5 seconds delay (ensures multiple downloads work)
})
.catch(error => console.error("Image download error:", error));
};

        // ✅ Update Order Status
        window.updateStatus = async function(orderId, currentStatus) {
            const statusList = ["Processing", "Shipped", "Delivered"];
            let newIndex = (statusList.indexOf(currentStatus) + 1) % statusList.length;
            let newStatus = statusList[newIndex];

            const orderRef = doc(db, "orders", orderId);
            await updateDoc(orderRef, { status: newStatus });

            document.getElementById(`status-${orderId}`).textContent = newStatus;
            alert("Order status updated to " + newStatus);
        };

        // ✅ Generate Order Receipt using HTML2PDF.js
        window.generateReceipt = function(orderId, order) {
const element = document.createElement("div");
element.style.padding = "20px";
element.style.border = "1px solid black";
element.style.fontFamily = "Arial, sans-serif";
element.style.width = "100%";
element.style.maxWidth = "500px";
element.style.margin = "auto";
element.innerHTML = `
<h2 style="text-align:center; margin-bottom: 20px;">Order Receipt</h2>
<p><strong>Order ID:</strong> ${orderId}</p>
<p><strong>Customer Name:</strong> ${order.fullName}</p>
<p><strong>Mobile:</strong> ${order.mobile}</p>
<p><strong>Price:</strong> ₹${order.price}</p>
<p><strong>Payment Status:</strong> ${order.paymentStatus}</p>
`;

document.body.appendChild(element); // ✅ Ensure it's in the DOM

html2pdf().from(element).set({
margin: 10,
filename: `receipt_${orderId}.pdf`,
image: { type: 'jpeg', quality: 0.98 },
html2canvas: { scale: 2, useCORS: true },
jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
}).save().then(() => {
document.body.removeChild(element); // ✅ Clean up after download
});
};
        // ✅ Logout
        window.logout = function() {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            });
        };

        // ✅ Open & Close Image Modal
        window.openModal = function(imgUrl) {
            document.getElementById("modalImg").src = imgUrl;
            document.getElementById("modal").classList.remove("hidden");
        };
        window.closeModal = function() {
            document.getElementById("modal").classList.add("hidden");
        };

    </script>
</body>
</html>